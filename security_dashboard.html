<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†</title>
<link rel="stylesheet" href="../CSS/f.css">
</head>
<body>
<h2>ğŸ‘® Ù†Ø¸Ø§Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù† - Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</h2>

<div id="main">
  <h3>Ø·Ù„Ø¨Ø§Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒÙ„ÙŠØ©</h3>
  <table id="applicants">
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  </table>
  <a href="#" class="report-btn" onclick="showReport()">ğŸ“„ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</a>
</div>

<div id="violationBox" class="popup" style="display:none;">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©</h3>
  <input type="hidden" id="vid">
  <textarea id="vdesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©..."></textarea><br>
  <button onclick="saveViolation()">Ø­ÙØ¸</button>
  <button onclick="closePopup()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="report" style="display:none;">
  <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
  <table id="reportTable">
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
      <th>Ø§Ù„ÙˆØµÙ</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    </tr>
  </table>
  <a href="#" class="report-btn" onclick="back()">ğŸ”™ Ø±Ø¬ÙˆØ¹</a>
</div>

<script>
const API = "../PHP/security_api.php";

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†)
async function loadApplicants() {
  const res = await fetch(API + "?action=list");
  const data = await res.json();

  const table = document.getElementById("applicants");
  table.innerHTML = `
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  `;

  data.forEach(a => {
    let actionsHtml = "";

    if (a.status === "violated") {
      // Ø¹Ù„ÙŠÙ‡ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹ â†’ Ù…Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ù‡Ù†Ø§
      actionsHtml = `<span>âš ï¸ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø³Ø¬Ù‘Ù„Ø©</span>`;
    } else {
      // ÙÙ‚Ø· Ø¥Ø±Ø³Ø§Ù„ Ù…Ø®Ø§Ù„ÙØ©
      actionsHtml = `<button class="violate" onclick="openPopup(${a.id})">Ø¥Ø¨Ù„Ø§Øº Ù…Ø®Ø§Ù„ÙØ©</button>`;
    }

    table.innerHTML += `
      <tr>
        <td>${a.name}</td>
        <td>${a.academic_id}</td>
        <td>${a.status_text}</td>
        <td>${actionsHtml}</td>
      </tr>
    `;
  });
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
function openPopup(id) {
  document.getElementById("vid").value = id;
  document.getElementById("vdesc").value = "";
  document.getElementById("violationBox").style.display = "block";
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closePopup() {
  document.getElementById("violationBox").style.display = "none";
}

// Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
async function saveViolation() {
  const id   = document.getElementById("vid").value;
  const desc = document.getElementById("vdesc").value.trim();

  if (!desc) {
    alert("ğŸ“ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ù„Ù„Ù…Ø®Ø§Ù„ÙØ©");
    return;
  }

  await fetch(API + "?action=violation", {
    method: "POST",
    body: new URLSearchParams({ id, desc })
  });

  alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
  closePopup();
  loadApplicants();
}

// Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
async function showReport() {
  document.getElementById("main").style.display   = "none";
  document.getElementById("report").style.display = "block";

  const res  = await fetch(API + "?action=report");
  const data = await res.json();

  const table = document.getElementById("reportTable");
  table.innerHTML = `
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
      <th>Ø§Ù„ÙˆØµÙ</th>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    </tr>
  `;

  data.forEach(r => {
    table.innerHTML += `
      <tr>
        <td>${r.name}</td>
        <td>${r.academic_id}</td>
        <td>${r.description}</td>
        <td>${r.date}</td>
      </tr>
    `;
  });
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function back() {
  document.getElementById("report").style.display = "none";
  document.getElementById("main").style.display   = "block";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadApplicants();
</script>
</body>
</html>
